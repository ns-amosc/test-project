name: AI Code Review
on:
  pull_request:
    types: [ opened, synchronize, reopened ]
    paths:
      - 'tests/**/*_test.py'
      - 'tests/**/test_*.py'
      - '**/*_test.py'
      - '**/test_*.py'

jobs:
  code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12.9'

      - name: Install dependencies
        run: |
          pip install requests urllib3

      - name: Verify script path and make executable
        run: |
          # é¦–å…ˆæª¢æŸ¥ scripts ç›®éŒ„ä¸­çš„è…³æœ¬
          if [ -f "scripts/ai_code_reviewer.py" ]; then
            chmod +x scripts/ai_code_reviewer.py
            echo "Script found at scripts/ai_code_reviewer.py"
            SCRIPT_PATH="scripts/ai_code_reviewer.py"
          # ç„¶å¾Œæª¢æŸ¥æ ¹ç›®éŒ„ä¸­çš„è…³æœ¬
          elif [ -f "ai_code_reviewer.py" ]; then
            chmod +x ai_code_reviewer.py
            echo "Script found at ai_code_reviewer.py"
            SCRIPT_PATH="ai_code_reviewer.py"
          # æœ€å¾Œæª¢æŸ¥å…¶ä»–å¯èƒ½çš„ä½ç½®
          else
            SCRIPT_PATH=$(find . -name "ai_code_reviewer.py" | head -n 1)
            if [ -n "$SCRIPT_PATH" ]; then
              chmod +x "$SCRIPT_PATH"
              echo "Script found at $SCRIPT_PATH"
            else
              echo "Error: ai_code_reviewer.py not found"
              exit 1
            fi
          fi
          echo "SCRIPT_PATH=$SCRIPT_PATH" >> $GITHUB_ENV

      - name: Debug environment
        run: |
          echo "Working directory: $(pwd)"
          echo "Script path: $SCRIPT_PATH"
          echo "Test files found:"
          find . -name "*test*.py" -type f
          echo "Files in current directory:"
          ls -la
          echo "Prompt file exists: $([ -f prompt.md ] && echo "Yes" || echo "No")"
          echo "Python version: $(python --version)"

      - name: Get changed files
        id: changed-files
        run: |
          # Act ç’°å¢ƒä¸­å¯èƒ½ç„¡æ³•ä½¿ç”¨ git diff å‘½ä»¤ï¼Œæ‰€ä»¥æ·»åŠ æ›´å¼·å¥çš„å›é€€æ©Ÿåˆ¶
          mkdir -p .act_temp
          
          # å˜—è©¦ä½¿ç”¨ git diff
          if git diff --name-only master..HEAD > .act_temp/changed_files.txt 2>/dev/null; then
            echo "Git diff successful"
          # å˜—è©¦ä½¿ç”¨ git diff èˆ‡å…¶ä»–å¯èƒ½çš„åŸºæº–åˆ†æ”¯
          elif git diff --name-only origin/master..HEAD > .act_temp/changed_files.txt 2>/dev/null; then
            echo "Git diff with origin/master successful"
          elif git diff --name-only main..HEAD > .act_temp/changed_files.txt 2>/dev/null; then
            echo "Git diff with main successful"
          elif git diff --name-only origin/main..HEAD > .act_temp/changed_files.txt 2>/dev/null; then
            echo "Git diff with origin/main successful"
          # å›é€€åˆ°åˆ—å‡ºæ‰€æœ‰æ¸¬è©¦æ–‡ä»¶
          else
            echo "Using fallback: listing all test files"
            find . -name "*test*.py" -o -name "test_*.py" -type f > .act_temp/changed_files.txt
          fi
          
          # å¦‚æœæ²’æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ä»¶ï¼Œè‡³å°‘åŒ…å«ä¸€å€‹æ¸¬è©¦æ–‡ä»¶ä»¥ä¾¿æ–¼æ¸¬è©¦
          if [ ! -s .act_temp/changed_files.txt ]; then
            echo "No files found, adding test_calculator.py as fallback"
            echo "tests/test_calculator.py" > .act_temp/changed_files.txt
          fi
          
          echo "Files to review:"
          cat .act_temp/changed_files.txt

      - name: Review changed files
        id: review
        env:
          # Act ä½¿ç”¨ .env æˆ–å‘½ä»¤è¡Œè¨­ç½®çš„ç’°å¢ƒè®Šæ•¸
          # å¦‚æœæ‚¨ä½¿ç”¨ -s æ¨™èªŒæä¾›äº†å¯†é‘°ï¼Œå®ƒå€‘æ‡‰è©²å¯ç”¨
          AI_TOKEN: ${{ secrets.AI_TOKEN }}
          AI_COOKIES: ${{ secrets.AI_COOKIES }}
        run: |
          # å‰µå»ºè¼¸å‡ºç›®éŒ„
          mkdir -p .act_temp/reports
          
          echo "# ğŸ¤– AI Code Review Report" > review_report.md
          echo "**Review Time:** $(date '+%Y-%m-%d %H:%M:%S')" >> review_report.md
          echo "" >> review_report.md
          
          # æ·»åŠ  Act èª¿è©¦ä¿¡æ¯
          echo "## ç’°å¢ƒä¿¡æ¯" >> review_report.md
          echo "- é‹è¡Œç’°å¢ƒ: Act æœ¬åœ°æ¨¡æ“¬" >> review_report.md
          echo "- å·¥ä½œç›®éŒ„: $(pwd)" >> review_report.md
          echo "- è…³æœ¬è·¯å¾‘: $SCRIPT_PATH" >> review_report.md
          echo "- Python ç‰ˆæœ¬: $(python --version)" >> review_report.md
          echo "" >> review_report.md
          
          # è™•ç†æ¯å€‹è®Šæ›´çš„æ–‡ä»¶
          while IFS= read -r file; do
            if [[ "$file" =~ tests/.*_test\.py$ ]] || [[ "$file" =~ tests/.*/test_.*\.py$ ]] || [[ "$file" =~ .*_test\.py$ ]] || [[ "$file" =~ .*/test_.*\.py$ ]]; then
              echo "Reviewing: $file"
          
              # ç²å–æ–‡ä»¶è®Šæ›´ï¼ˆä½¿ç”¨å¤šç¨®å›é€€æ©Ÿåˆ¶ï¼‰
              echo "Getting changes for $file"
              if git diff --unified=3 master..HEAD -- "$file" > .act_temp/temp_diff.txt 2>/dev/null; then
                changes=$(cat .act_temp/temp_diff.txt)
                echo "Found changes via git diff master..HEAD"
              elif git diff --unified=3 origin/master..HEAD -- "$file" > .act_temp/temp_diff.txt 2>/dev/null; then
                changes=$(cat .act_temp/temp_diff.txt)
                echo "Found changes via git diff origin/master..HEAD"
              elif git diff --unified=3 main..HEAD -- "$file" > .act_temp/temp_diff.txt 2>/dev/null; then
                changes=$(cat .act_temp/temp_diff.txt)
                echo "Found changes via git diff main..HEAD"
              elif [ -f "$file" ]; then
                changes=$(cat "$file")
                echo "Using entire file content as changes"
              else
                changes="No changes found or file does not exist: $file"
                echo "$changes"
              fi
          
              echo "## ğŸ“ \`$file\`" >> review_report.md
              echo "" >> review_report.md
          
              if [[ -n "$changes" && "$changes" != "No changes found"* ]]; then
                # ä½¿ç”¨å®Œæ•´è·¯å¾‘èª¿ç”¨ AI å¯©æŸ¥
                echo "Running review with script: $SCRIPT_PATH"
          
                # ä¿å­˜è®Šæ›´åˆ°è‡¨æ™‚æ–‡ä»¶ä»¥é¿å…å‘½ä»¤è¡Œéé•·å•é¡Œ
                echo "$changes" > .act_temp/current_changes.txt
          
                # ç”¨ç’°å¢ƒè®Šæ•¸èª¿ç”¨ AI å¯©æŸ¥ï¼Œæ•ç²è¼¸å‡ºå’ŒéŒ¯èª¤
                if AI_TOKEN="$AI_TOKEN" AI_COOKIES="$AI_COOKIES" python "$SCRIPT_PATH" "$file" "$(cat .act_temp/current_changes.txt)" --prompt prompt.md > .act_temp/review_output.txt 2> .act_temp/review_error.txt; then
                  cat .act_temp/review_output.txt >> review_report.md
                  echo "Review completed successfully"
                else
                  echo "âš ï¸ Review failed with error:" >> review_report.md
                  echo '```' >> review_report.md
                  cat .act_temp/review_error.txt >> review_report.md
                  cat .act_temp/review_output.txt >> review_report.md
                  echo '```' >> review_report.md
                  echo "Review failed - see error above"
                fi
              else
                echo "No substantive changes found in this file." >> review_report.md
              fi
          
              echo "" >> review_report.md
              echo "---" >> review_report.md
            fi
          done < .act_temp/changed_files.txt
          
          # å¦‚æœæ²’æœ‰æ·»åŠ ä»»ä½•å¯©æŸ¥
          if ! grep -q "## ğŸ“" review_report.md; then
            echo "No test files found for review or all reviews failed." >> review_report.md
          fi
          
          # ä¿å­˜å ±å‘Šä»¥ä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          cp review_report.md .act_temp/reports/
          echo "Review report saved to review_report.md"
          cat review_report.md

      # æ­¤æ­¥é©Ÿåœ¨ Act ä¸­å¯èƒ½ç„¡æ³•æ­£å¸¸å·¥ä½œï¼Œå› ç‚ºå®ƒä¾è³´æ–¼ GitHub API
      # ä½†æˆ‘å€‘ä¿ç•™å®ƒç”¨æ–¼å¯¦éš›çš„ GitHub Actions åŸ·è¡Œ
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            try {
              // è®€å–å¯©æŸ¥å ±å‘Š
              const reviewReport = fs.readFileSync('review_report.md', 'utf8');
            
              // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ©Ÿå™¨äººè©•è«–
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
            
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('AI Code Review Report')
              );
            
              if (botComment) {
                // æ›´æ–°ç¾æœ‰è©•è«–
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: reviewReport
                });
                console.log(`Updated existing comment ID ${botComment.id}`);
              } else {
                // å‰µå»ºæ–°è©•è«–
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: reviewReport
                });
                console.log('Created new comment');
              }
            } catch (error) {
              console.error('Error posting comment:', error);
            }